/**
 * @license darlingjs v0.0.1 2013-04-30 by Eugene Krevenets.
 * Component & Entity based javascript game engine. Decoupled from any visualization, physics, and so on. With injections and modules based on AngularJS.
 * http://darlingjs.github.io/
 *
 */

(function(t,e){"use strict";function n(t){return t!==e}function r(t){return t===e}function o(t){return null!==t&&"object"==typeof t}function i(t){return"[object Array]"===S.apply(t)}function s(t){return"string"==typeof t}function a(t){return t&&t.document&&t.location&&t.alert&&t.setInterval}function u(t){return"[object Date]"===S.apply(t)}function c(t){return"function"==typeof t}function f(t,e,n){if(a(t))throw Error("Can't copy Window");if(e){if(t===e)throw Error("Can't copy equivalent objects or arrays");if(i(t)){e.length=0;for(var r=0;t.length>r;r++)e.push(f(t[r]))}else{n&&l(e,function(t,n){delete e[n]});for(var s in t)t.hasOwnProperty(s)&&(e[s]=f(t[s]))}}else e=t,t&&(i(t)?e=f(t,[]):u(t)?e=new Date(t.getTime()):o(t)&&(e=f(t,{})));return e}function h(t){return t&&"number"==typeof t.length?"function"!=typeof t.hasOwnProperty&&"function"!=typeof t.constructor?!0:t instanceof JQLite||jQuery&&t instanceof jQuery||"[object Object]"!==S.call(t)||"function"==typeof t.callee:!1}function l(t,e,n){var r;if(t)if(c(t))for(r in t)"prototype"!==r&&"length"!==r&&"name"!==r&&t.hasOwnProperty(r)&&e.call(n,t[r],r);else if(t.forEach&&t.forEach!==l)t.forEach(e,n);else if(h(t))for(r=0;t.length>r;r++)e.call(n,t[r],r);else for(r in t)t.hasOwnProperty(r)&&e.call(n,t[r],r);return t}function $(t){var e,n,r,o;return"function"==typeof t?(e=t.$inject)||(e=[],n=(""+t).replace(H,""),r=n.match(I),l(r[1].split(k),function(t){t.replace(M,function(t,n,r){e.push(r)})}),t.$inject=e):i(t)?(o=t.length-1,p(t[o],"fn"),e=t.slice(0,o)):p(t,"fn",!0),e}function p(t,e,n){return n&&i(t)&&(t=t[t.length-1]),m(c(t),e,"not a function, got "+(t&&"object"==typeof t?t.constructor.name||"Object":typeof t)),t}function m(t,e,n){if(!t)throw Error("Argument '"+(e||"?")+"' is "+(n||"required"));return t}function d(){}function y(t,e){if(null===e||null===t)return t;for(var n in e)t[n]=e[n]}function v(t,e){if(null===e)return t;for(var n in e){var r=e[n];"object"!=typeof r?t[n]=r:(t[n]&&"object"==typeof t[n]||(t[n]={}),v(t[n],r))}return t}function g(t,e,n,r){return e.hasOwnProperty(r)?E(t,e,n,r):w(t,e,n)}function w(t,e,n){switch(n.length){case 0:return function(){return t.call(e)};case 1:return function(){return t.call(e,n[0])};case 2:return function(){return t.call(e,n[0],n[1])};case 3:return function(){return t.call(e,n[0],n[1],n[2])};default:return function(){return t.apply(e,n)}}}function E(t,e,n,r){switch(n.length){case 0:return function(){return e[r]()};case 1:return function(){return e[r](n[0])};case 2:return function(){return e[r](n[0],n[1])};case 3:return function(){return e[r](n[0],n[1],n[2])};default:return function(){return t.apply(e,n)}}}function F(t,e,n,r,o){return e.hasOwnProperty(o)?O(t,e,n,r,o):N(t,e,n,r)}function N(t,e,n,r){switch(n.length){case 0:return function(){return t.call(e)};case 1:return function(){return r(n,arguments),t.call(e,n[0])};case 2:return function(){return r(n,arguments),t.call(e,n[0],n[1])};case 3:return function(){return r(n,arguments),t.call(e,n[0],n[1],n[2])};default:return function(){return r(n,arguments),t.apply(e,n)}}}function O(t,e,n,r,o){switch(n.length){case 0:return function(){return e[o]()};case 1:return function(){return r(n,arguments),e[o](n[0])};case 2:return function(){return r(n,arguments),e[o](n[0],n[1])};case 3:return function(){return r(n,arguments),e[o](n[0],n[1],n[2])};default:return function(){return r(n,arguments),t.apply(e,n)}}}function C(t){return o(t)&&n(t.$name)}function x(){this.components=[],this.componentsString="",this.componentsHash={},this.nodes=new G,this.$$marker=null}function P(t,e){var n=t.indexOf(e);return n>=0?function(t,e){t[n]=e}:d}function b(t){var e=P(t,"$time"),n=P(t,"$nodes");return function(t,r){e(t,r[0]),n(t,r[1])}}function T(t){for(var e=0,n=t.length;n>e;e++)if("$node"===t[e])return function(t,n){t[e]=n[0]};return d}function j(t,e,n,o,i){r(t._matchingToFamily)&&(t._matchingToFamily={processing:!1,phases:{}});var s=t._matchingToFamily.phases[e];return r(s)&&(s=[],t._matchingToFamily.phases[e]=s),t._matchingToFamily.processing?(s.push({fn:o,ctx:n,args:i}),!1):(t._matchingToFamily.processing=!0,!0)}function A(t){t._matchingToFamily.processing=!1;var n=t._matchingToFamily.phases;for(var r in n)if(n.hasOwnProperty(r)){var o=t._matchingToFamily.phases[r];if(o.length>0){var i=o.pop();return i.fn.apply(i.ctx,i.args),e}}}(function(){for(var n=0,r=["ms","moz","webkit","o"],o=0;r.length>o&&!t.requestAnimationFrame;++o)t.requestAnimationFrame=t[r[o]+"RequestAnimationFrame"],t.cancelAnimationFrame=t[r[o]+"CancelAnimationFrame"]||t[r[o]+"CancelRequestAnimationFrame"];t.requestAnimationFrame===e&&(t.requestAnimationFrame=function(e){var r=Date.now(),o=Math.max(0,16-(r-n)),i=t.setTimeout(function(){e(r+o)},o);return n=r+o,i}),t.cancelAnimationFrame=t.cancelAnimationFrame||function(e){t.clearTimeout(e)}})();var R=t.darlingutil=t.darlingutil||{};(function(){function e(t,e,n){var r=document.getElementById(t);if(null===r)throw Error("Can't find DOM element with id: \""+t+'"');var o=document.createElement("div");o.style.position="absolute",o.style.top="0px",r.appendChild(o);var i=document.createElement("canvas");return i.width=e||r.clientWidth,i.height=n||r.clientHeight,o.appendChild(i),i}function n(t){t.parentNode&&(t.parentNode.parentNode&&t.parentNode.parentNode.removeChild(t.parentNode),t.parentNode.removeChild(t))}function r(){var t=-1;if("Microsoft Internet Explorer"==navigator.appName){var e=navigator.userAgent,n=RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");null!=n.exec(e)&&(t=parseFloat(RegExp.$1))}return t}function o(){var e=0;if(t.opera){var n=t.opera.version();e=parseFloat(n)}return e}function i(t){var e={};if(e.x=0,e.y=0,null!==t)if(t.getBoundingClientRect){var n=document.documentElement,r=t.getBoundingClientRect(),o=n.scrollLeft,i=n.scrollTop;e.x=r.left+o,e.y=r.top+i}else{e.x=t.offsetLeft,e.y=t.offsetTop;for(var s=t.parentNode,u=null;null!==offsetParent;){e.x+=offsetParent.offsetLeft,e.y+=offsetParent.offsetTop;var h=offsetParent.tagName.toLowerCase();if((f&&"table"!=h||($||m)&&"td"==h)&&(u=kGetBorderWidth(offsetParent),e.x+=u.left,e.y+=u.top),offsetParent!=document.body&&offsetParent!=document.documentElement&&(e.x-=offsetParent.scrollLeft,e.y-=offsetParent.scrollTop),!a&&!v||c)for(;offsetParent!=s&&null!==s;)e.x-=s.scrollLeft,e.y-=s.scrollTop,(l||p)&&(u=kGetBorderWidth(s),e.x+=u.left,e.y+=u.top),s=s.parentNode;s=offsetParent.parentNode,offsetParent=offsetParent.offsetParent}}return e}R.getCanvas=function(t){var e=document.getElementById(t);if(null===e)throw Error("Can't find DOM element with id: \""+t+'"');return R.isDefined(e.getContext)?e:null},R.placeCanvasInStack=e,R.removeCanvasFromStack=n;var s=navigator.userAgent,a=null!=navigator.appVersion.match(/MSIE/),u=r(),c=a&&u>=8,f=a&&!c,h=null!=s.match(/firefox/i),l=h&&(null!=s.match(/firefox\/2./i)||null!=s.match(/firefox\/1./i)),$=h&&!l,p=null!=navigator.appVersion.match(/WebKit/),m=null!=navigator.appVersion.match(/Chrome/),d=null!=t.opera,y=o(),v=d&&10>y,g=R;g.getElementAbsolutePlacement=function(t){var e=i(t);return e.width=t.offsetWidth,e.height=t.offsetHeight,e},g.getElementAbsolutePos=i})();var S=Object.prototype.toString;R.isDefined=n,R.isUndefined=r,R.isObject=o,R.isArray=i,R.isString=s,R.isWindow=a,R.isDate=u,R.isFunction=c;var I=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,k=/,/,M=/^\s*(_?)(\S+?)\1\s*$/,H=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,D=[],L=D.slice,q={on:function(t,e,n){if(!W(this,"on",t,[e,n])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);return r.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,n){if(!W(this,"once",t,[e,n])||!e)return this;var r=this,o=_.once(function(){r.off(t,o),e.apply(this,arguments)});return o._callback=e,this.on(t,o,n)},off:function(t,e,n){var r,o,i,s,a,u,c,f;if(!this._events||!W(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(s=t?[t]:_.keys(this._events),a=0,u=s.length;u>a;a++)if(t=s[a],i=this._events[t]){if(this._events[t]=r=[],e||n)for(c=0,f=i.length;f>c;c++)o=i[c],(e&&e!==o.callback&&e!==o.callback._callback||n&&n!==o.context)&&r.push(o);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=L.call(arguments,1);if(!W(this,"trigger",t,e))return this;var n=this._events[t],r=this._events.all;return n&&K(n,e),r&&K(r,arguments),this},stopListening:function(t,e,n){var r=this._listeners;if(!r)return this;var o=!e&&!n;"object"==typeof e&&(n=this),t&&((r={})[t._listenerId]=t);for(var i in r)r[i].off(e,n,this),o&&delete this._listeners[i];return this}},B=/\s+/,W=function(t,e,n,r){if(!n)return!0;if("object"==typeof n){for(var o in n)t[e].apply(t,[o,n[o]].concat(r));return!1}if(B.test(n)){for(var i=n.split(B),s=0,a=i.length;a>s;s++)t[e].apply(t,[i[s]].concat(r));return!1}return!0},K=function(t,e){var n,r=-1,o=t.length,i=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;o>++r;)(n=t[r]).callback.call(n.ctx);return;case 1:for(;o>++r;)(n=t[r]).callback.call(n.ctx,i);return;case 2:for(;o>++r;)(n=t[r]).callback.call(n.ctx,i,s);return;case 3:for(;o>++r;)(n=t[r]).callback.call(n.ctx,i,s,a);return;default:for(;o>++r;)(n=t[r]).callback.apply(n.ctx,e)}};R.wipe=function(t){for(var e in t)t.hasOwnProperty(e)&&delete t[e]};var U=t.darlingjs||(t.darlingjs={}),Y={},Q={};U.m=U.module=function(t,e){if(n(Q[t]))throw Error('Module "'+t+'" has already been defined.');var r=new Z;return r.name=t,r.requires=e,Q[t]=r,r},U.w=U.world=function(t,e){if(n(Y[t]))throw Error('World "'+t+'" has already been defined.');var o=new ee;if(o.name=t,Y[t]=o,i(e))for(var s=0,a=e.length;a>s;s++){var u=e[s],c=Q[u];if(r(c))throw Error("Can't find module: \""+u+'"');o.$$injectedModules[u]=c;var f=c.$$components;for(var h in f)if(f.hasOwnProperty(h)){var l=c.$$components[h];if(r(l))throw Error('Module: "'+this.name+'" has null component with name "'+h+'".');o.$$injectedComponents[l.name]=l}var $=c.$$systems;for(var p in $)if($.hasOwnProperty(p)){var m=$[p];if(r(m))throw Error('Module: "'+this.name+'" has null system with name "'+p+'".');o.$$injectedSystems[m.name]=m}}return o},U.removeModule=function(t){delete Q[t]},U.removeAllModules=function(){console.log("removeAllModules"),Q={}},U.removeWorld=function(t){if(R.isString(t))delete Y[t];else for(var e in Y)if(Y[e]===t){delete Y[e];break}},U.removeAllWorlds=function(){Y={}};var V=function(){this.$$components={},this.$$world=null,v(this,q)};V.prototype.$add=function(t,e){var n,o;if(s(t))n=this.$$world.$component(t,e),o=t;else{if(!C(t))throw r(t)?Error("Can't add component with null name."):Error("Can't add "+t+" to entity");n=t,o=n.$name}if(r(n))throw Error("Can't add null component.");return this.$has(o)&&this.$remove(o),this.$$components[o]=n,this[o]=n,this.trigger("add",this,n),n},V.prototype.$remove=function(t){var n,r;if(C(t))r=t.$name,n=t;else{if(!s(t))throw Error("Can't remove from component "+t);r=t,n=this.$$components[t]}return this.$has(r)?(delete this.$$components[r],delete this[r],this.trigger("remove",this,n),n):e},V.prototype.$has=function(t){return C(t)?n(this.$$components[t.$name]):n(this.$$components[t])},x.prototype.$marker=function(){return null===this.$$marker&&(this.$$marker="$$family_"+this.componentsString,this.nodes.PROPERTY_LINK_TO_NODE="$$listNode_of_"+this.$$marker),this.$$marker},x.prototype.newEntity=function(t){this.addIfMatch(t)},x.prototype.addIfMatch=function(t){if(!this.isInList(t)){for(var e=0,n=this.components.length;n>e;e++){var r=this.components[e];if(!t.$has(r))return}t[this.$marker()]=!0,this.nodes.add(t)}},x.prototype.removeIfMatch=function(t,e){n(e)&&!this.componentsHash[e.$name]||!this.isInList(t)||(delete t[this.$$marker],this.nodes.remove(t))},x.prototype.isInList=function(t){return t.hasOwnProperty(this.$$marker)};var G=function(){this._head=this._tail=null,this._length=0,this.PROPERTY_LINK_TO_NODE="$$listNode_"+Math.random(),v(this,q)};R.List=G,G.prototype.add=function(t){var e=X.get();return e.init(t,this.PROPERTY_LINK_TO_NODE),this._head?(this._tail.$next=e,e.$prev=this._tail,this._tail=e):this._head=this._tail=e,t?this.trigger("add",t):this.trigger("add",e),this._length++,e},G.prototype.addHead=function(t){var e=X.get();return e.init(t,this.PROPERTY_LINK_TO_NODE),this._head?(this._head.$prev=e,e.$next=this._head,this._head=e):this._head=this._tail=e,t?this.trigger("add",t):this.trigger("add",e),this._length++,e},G.prototype.remove=function(t){var e;if(t instanceof z)e=t;else{if(!t.hasOwnProperty(this.PROPERTY_LINK_TO_NODE))return!1;if(e=t[this.PROPERTY_LINK_TO_NODE],null===e)return!1}return this._tail===e&&(this._tail=e.$prev),this._head===e&&(this._head=e.$next),null!==e.$prev&&(e.$prev.$next=e.$next),null!==e.$next&&(e.$next.$prev=e.$prev),e.dispose(t,this.PROPERTY_LINK_TO_NODE),X.dispose(e),this.trigger("remove",t),this._length--,!0},G.prototype.length=function(){return this._length},G.prototype.forEach=function(t,e,n){if(e=e||this,c(t))for(var r=this._head;r;)t.call(e,r.instance,n),r=r.$next};var z=function(t,e){t&&this.init(t,e)};z.prototype.$next=null,z.prototype.$prev=null,z.prototype.init=function(t,e){if(this.$prev=this.$next=null,t){if(this.instance=t,t.hasOwnProperty(e))throw Error("Can't store \""+t+'" because it containe '+e+" property.");t[e]=this}},z.prototype.dispose=function(t,e){this.$prev=this.$next=null,this.instance=null,delete t[e]};var J=function(t){var e=[];this.get=function(){return 0===e.length?new t:e.pop()},this.dispose=function(t){e.push(t)}},X=new J(z),Z=function(){this.$$components={},this.$$systems={}};Z.prototype.$has=function(t){return n(this.$$components[t])||n(this.$$systems[t])},Z.prototype.$c=Z.prototype.$component=function(t,e){e=e||{};var n={name:t,defaultState:e};return this.$$components[t]=n,this},Z.prototype.$s=Z.prototype.$system=function(t,e){if(r(t))throw Error("System name must to be defined.");if(e=e||{},e.name=t,n(this.$$systems[t]))throw Error('Module "'+this.name+'" already has system with name "'+t+'".');return this.$$systems[t]=e,this};var te=function(){this.$$updateHandler=function(){},this.init()};te.prototype.init=function(){this.$setNodes(new G)},te.prototype.$setNodes=function(t){this.$nodes=t;var e=this;this.$nodes.on("add",function(t){e.$$addNodeHandler(t)}),this.$nodes.on("remove",function(t){e.$$removeNodeHandler(t)})},te.prototype.$$updateEveryNode=function(t,e){return function(n){this.$nodes.forEach(t,e,n)}};var ee=function(){this.$$injectedComponents={},this.$$injectedModules={},this.$$injectedSystems={},this.$$systems=[],this.$$families={},this.$$interval=1,this.$$updating=!1,this.$playing=!1,this.$entities=new G,this.$name=""};ee.prototype.$has=function(t){return n(this.$$injectedComponents[t])||n(this.$$injectedModules[t])||n(this.$$injectedSystems[t])},ee.prototype.$isUse=function(t){if(t instanceof te)return this.$$systems.indexOf(t)>=0;for(var e=0,n=this.$$systems.length;n>e;e++)if(this.$$systems[e].name===t)return!0;return!1},ee.prototype.$add=function(t,e){var n;if(s(t)){if(n=this.$$injectedSystems[t],r(n))throw Error('Instance of "'+t+'" doesn\'t injected in the world "'+this.name+'".')}else n=t;return n instanceof V?n=this.$$addEntity(n):n instanceof te?this.$$addSystem(n):null!==n&&(n=this.$system(t,e),this.$$addSystem(n)),n},ee.prototype.$$addEntity=function(t){return this.$entities.add(t),t.on("add",this.$$onComponentAdd,this),t.on("remove",this.$$onComponentRemove,this),this.$$matchNewEntityToFamilies(t),t},ee.prototype.$$removeEntity=function(t){return this.$entities.remove(t),this.$$matchRemoveEntityToFamilies(t),t.off("add",this.$$onComponentAdd),t.off("remove",this.$$onComponentRemove),t},ee.prototype.$$getDependencyByAnnotation=function(t,e){e=e||[];for(var n=0,r=t.length;r>n;n++){var o=t[n];e[n]=this.$$getDependencyByName(o)}return e},ee.prototype.$$getDependencyByName=function(t){switch(t){case"$world":return this}return this.$$getSystemByName(t)},ee.prototype.$remove=function(t){if(t instanceof V)this.$$removeEntity(t);else{if(!(t instanceof te))throw Error("can't remove \""+t+'" from world "'+this.name+'"');this.$$removeSystem(t)}},ee.prototype.$$getSystemByName=function(t){for(var e=0,n=this.$$systems.length;n>e;e++)if(this.$$systems[e].name===t)return this.$$systems[e];return null},ee.prototype.$$addSystem=function(t){return this.$$systems.push(t),t.$$addedHandler(),n(t.$require)&&t.$setNodes(this.$queryByComponents(t.$require)),t},ee.prototype.$$removeSystem=function(t){var e=this.$$systems.indexOf(t);return this.$$systems.splice(e),t.init(),t.$$removedHandler(),t},ee.prototype.$getByName=function(t){for(var e=this.$entities._head;e;){var n=e.instance;if(n.$name===t)return n;e=e.$next}return null},ee.prototype.$numEntities=function(){return this.$entities.length()},ee.prototype.$e=ee.prototype.$entity=function(){var t="",e=0;s(arguments[0])&&(t=arguments[0],e=1);var a=new V;if(a.$name=t,a.$$world=this,i(arguments[e])){for(var u=arguments[e],c=0,f=u.length;f>c;c++)if(s(u[c])){var h=u[c],l=this.$$injectedComponents[h],$={};if(r(l))throw Error("World "+this.name+" doesn't has component "+h+". Only "+this.$$injectedComponents);o(u[c+1])?(c++,$=u[c]):$=null,a.$add(h,$)}}else if(o(arguments[e])){var p=arguments[e];for(var m in p)p.hasOwnProperty(m)&&"$"!==m.charAt(0)&&a.$add(m,p[m]);n(p.$name)&&(a.$name=p.$name)}return a},ee.prototype.$c=ee.prototype.$component=function(t,e){var o,i;if(!s(t))throw Error("1st argument must be [String]");if(o=this.$$injectedComponents[t],r(o))throw Error("Can't find component \""+t+'" definition. You need to add appropriate module to world.');return i=f(o.defaultState),n(e)&&y(i,e),i.$name=t,i},ee.prototype.annotatedFunctionFactory=function(t,e,o){var s=t[e];if(r(s))return d;if(i(s)){o=o||d;var a=s[s.length-1];t[e]=a;var u=$(s),c=this.$$getDependencyByAnnotation(u),f=o(u);return n(f)?F(a,t,c,f):g(a,t,c,e)}return s},ee.prototype.$s=ee.prototype.$system=function(t,e){var r=this.$$injectedSystems[t],o=new te;if(f(r,o,!1),n(e)&&f(e,o,!1),o.$$beforeUpdateHandler=this.annotatedFunctionFactory(o,"$beforeUpdate",b),o.$$afterUpdateHandler=this.annotatedFunctionFactory(o,"$afterUpdate",b),n(o.$update))if(i(o.$update)){var s=o.$update,a=s[s.length-1],u=$(s);o.$$update=a;var c=this.$$getDependencyByAnnotation(u),h=P(u,"$node"),l=P(u,"$nodes"),p=P(u,"$time"),m=P(u,"$world"),y=this,v=g(a,o,c,"$$update"),w=u.indexOf("$node")>=0;o.$$updateHandler=w?o.$$updateEveryNode(function(t,e){p(c,e),h(c,t),l(c,o.$nodes),m(c,y),v()}):function(t){p(c,t),l(c,o.$nodes),m(c,y),v()}}else o.$$updateHandler=o.$update;return o.$$addedHandler=n(o.$added)?this.annotatedFunctionFactory(o,"$added",d):d,o.$$removedHandler=n(o.$removed)?this.annotatedFunctionFactory(o,"$removed",d):d,o.$$addNodeHandler=n(o.$addNode)?this.annotatedFunctionFactory(o,"$addNode",T):d,o.$$removeNodeHandler=n(o.$removeNode)?this.annotatedFunctionFactory(o,"$removeNode",T):d,o},ee.prototype.$$matchNewEntityToFamilies=function(t){if(j(t,"matchNewEntityToFamilies",this,this.$$matchNewEntityToFamilies,arguments)){for(var e in this.$$families){var n=this.$$families[e];n.newEntity(t)}A(t,"matchNewEntityToFamilies")}},ee.prototype.$$matchRemoveEntityToFamilies=function(t){if(j(t,"matchRemoveEntityToFamilies",this,this.$$matchRemoveEntityToFamilies,arguments)){for(var e in this.$$families){var n=this.$$families[e];n.removeIfMatch(t)}A(t,"matchRemoveEntityToFamilies")}},ee.prototype.$$onComponentAdd=function(t){if(j(t,"onComponentAdd",this,this.$$onComponentAdd,arguments)){for(var e in this.$$families){var n=this.$$families[e];n.addIfMatch(t)}A(t,"onComponentAdd")}},ee.prototype.$$onComponentRemove=function(t,e){if(j(t,"onComponentRemove",this,this.$$onComponentRemove,arguments)){for(var n in this.$$families){var r=this.$$families[n];r.removeIfMatch(t,e)}A(t,"onComponentRemove")}},ee.prototype.$queryByComponents=function(t){var e,n,r={};if(i(t)?(n=t.join(","),e=t):s(t)&&(n=t,e=t.split(",")),this.$$families[n])return this.$$families[n].nodes;for(var o=0,a=e.length;a>o;o++)r[e[o]]=!0;var u=new x;return u.components=e,u.componentsHash=r,u.componentsString=n,this.$$families[n]=u,this.$entities.forEach(function(t){u.newEntity(t)}),u.nodes},ee.prototype.$update=function(t){this.$$updating=!0,t=t||this.$$interval;for(var e=0,n=this.$$systems.length;n>e;e++){var r=this.$$systems[e];r.$$beforeUpdateHandler(t,r.$nodes),r.$$updateHandler(t),r.$$afterUpdateHandler(t,r.$nodes)}this.$$updating=!1},ee.prototype.$start=function(){if(!this.$playing){this.$playing=!0;var e=this,n=0;(function r(o){var i=0;n&&(i=o-n),e.$update(i),n=o,e.$playing&&(e.$requestAnimationFrameId=t.requestAnimationFrame(r))})(0)}},ee.prototype.$stop=function(){this.$playing&&(this.$playing=!1,t.cancelAnimationFrame(this.$requestAnimationFrameId))}})(window);