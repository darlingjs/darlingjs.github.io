/**
 * @license darlingjs v0.7.0 2013-07-14 by Eugene Krevenets.
 * Component & Entity based javascript game engine. Decoupled from any visualization, physics, and so on. With injections and modules based on AngularJS.
 * http://darlingjs.github.io/
 *
 */

(function(t,e){"use strict";function n(t){return t!==e}function r(t){return t===e}function i(t){return null!==t&&"object"==typeof t}function o(t){return"[object Array]"===D.apply(t)}function a(t){return"string"==typeof t}function s(t){return t&&t.document&&t.location&&t.alert&&t.setInterval}function $(t){return"[object Date]"===D.apply(t)}function l(t){return"function"==typeof t}function u(t,e,n){if(s(t))throw Error("Can't copy Window");if(e){if(t===e)throw Error("Can't copy equivalent objects or arrays");if(o(t)){e.length=0;for(var r=0;t.length>r;r++)e.push(u(t[r]))}else{n&&h(e,function(t,n){delete e[n]});for(var a in t)t.hasOwnProperty(a)&&(e[a]=u(t[a]))}}else e=t,t&&(o(t)?e=u(t,[]):$(t)?e=new Date(t.getTime()):i(t)&&(e=u(t,{})));return e}function f(t){return t&&"number"==typeof t.length?"function"!=typeof t.hasOwnProperty&&"function"!=typeof t.constructor?!0:t instanceof JQLite||jQuery&&t instanceof jQuery||"[object Object]"!==D.call(t)||"function"==typeof t.callee:!1}function h(t,e,n){var r;if(t)if(l(t))for(r in t)"prototype"!==r&&"length"!==r&&"name"!==r&&t.hasOwnProperty(r)&&e.call(n,t[r],r);else if(t.forEach&&t.forEach!==h)t.forEach(e,n);else if(f(t))for(r=0;t.length>r;r++)e.call(n,t[r],r);else for(r in t)t.hasOwnProperty(r)&&e.call(n,t[r],r);return t}function c(t){var e,n,r,i;return"function"==typeof t?(e=t.$inject)||(e=[],n=(""+t).replace(W,""),r=n.match(L),h(r[1].split(q),function(t){t.replace(B,function(t,n,r){e.push(r)})}),t.$inject=e):o(t)?(i=t.length-1,d(t[i],"fn"),e=t.slice(0,i)):d(t,"fn",!0),e}function d(t,e,n){return n&&o(t)&&(t=t[t.length-1]),p(l(t),e,"not a function, got "+(t&&"object"==typeof t?t.constructor.name||"Object":typeof t)),t}function p(t,e,n){if(!t)throw Error("Argument '"+(e||"?")+"' is "+(n||"required"));return t}function m(){}function y(t,e){if(null===e||null===t)return t;for(var n in e)t[n]=e[n]}function v(t,e){if(null===e)return t;for(var n in e){var r=e[n];"object"!=typeof r?t[n]=r:(t[n]&&"object"==typeof t[n]||(t[n]={}),v(t[n],r))}return t}function g(t,e,n,r){return e.hasOwnProperty(r)?w(t,e,n,r):E(t,e,n)}function E(t,e,n){switch(n.length){case 0:return function(){return t.call(e)};case 1:return function(){return t.call(e,n[0])};case 2:return function(){return t.call(e,n[0],n[1])};case 3:return function(){return t.call(e,n[0],n[1],n[2])};case 4:return function(){return t.call(e,n[0],n[1],n[2],n[4])};default:return function(){return t.apply(e,n)}}}function w(t,e,n,r){switch(n.length){case 0:return function(){return e[r]()};case 1:return function(){return e[r](n[0])};case 2:return function(){return e[r](n[0],n[1])};case 3:return function(){return e[r](n[0],n[1],n[2])};case 4:return function(){return e[r](n[0],n[1],n[2],n[3])};default:return function(){return t.apply(e,n)}}}function F(t,e,n,r,i){return e.hasOwnProperty(i)?N(t,e,n,r,i):x(t,e,n,r)}function x(t,e,n,r){switch(n.length){case 0:return function(){return t.call(e)};case 1:return function(){return r(n,arguments),t.call(e,n[0])};case 2:return function(){return r(n,arguments),t.call(e,n[0],n[1])};case 3:return function(){return r(n,arguments),t.call(e,n[0],n[1],n[2])};default:return function(){return r(n,arguments),t.apply(e,n)}}}function N(t,e,n,r,i){switch(n.length){case 0:return function(){return e[i]()};case 1:return function(){return r(n,arguments),e[i](n[0])};case 2:return function(){return r(n,arguments),e[i](n[0],n[1])};case 3:return function(){return r(n,arguments),e[i](n[0],n[1],n[2])};case 4:return function(){return r(n,arguments),e[i](n[0],n[1],n[2],n[3])};default:return function(){return r(n,arguments),t.apply(e,n)}}}function b(t){return i(t)&&n(t.$name)}function H(){this.components=[],this.componentsString="",this.componentsHash={},this.nodes=new ne,this.$$marker=null}function C(){this.pool.dispose(this)}function O(t,e){for(var n in t)S(t,n,e)}function S(t,e,n){if(t.hasOwnProperty(e)&&"$"!==e.charAt(0)){var r=t[e];r===!1?n[e]=null:T(r)||null===r?n.$add(e,null):n.$add(e,r)}}function T(t){var e;for(e in t)return!1;return!0}function P(t,e){var n=t.indexOf(e);return n>=0?function(t,e){t[n]=e}:m}function k(t){var e=P(t,"$time"),n=P(t,"$entities");return function(t,r){e(t,r[0]),n(t,r[1])}}function j(t){for(var e=0,n=t.length;n>e;e++)if("$entity"===t[e])return function(t,n){t[e]=n[0]};return m}function A(t,e,n,i,o){r(t._matchingToFamily)&&(t._matchingToFamily={processing:!1,phases:{}});var a=t._matchingToFamily.phases[e];return r(a)&&(a=[],t._matchingToFamily.phases[e]=a),t._matchingToFamily.processing?(a.push({fn:i,ctx:n,args:o}),!1):(t._matchingToFamily.processing=!0,!0)}function M(t){t._matchingToFamily.processing=!1;var e=t._matchingToFamily.phases;for(var n in e)R(e,n,t)}function R(t,n,r){if(t.hasOwnProperty(n)){var i=r._matchingToFamily.phases[n];if(i.length>0){var o=i.pop();return o.fn.apply(o.ctx,o.args),e}}}(function(){for(var n=0,r=["ms","moz","webkit","o"],i=0;r.length>i&&!t.requestAnimationFrame;++i)t.requestAnimationFrame=t[r[i]+"RequestAnimationFrame"],t.cancelAnimationFrame=t[r[i]+"CancelAnimationFrame"]||t[r[i]+"CancelRequestAnimationFrame"];t.requestAnimationFrame===e&&(t.requestAnimationFrame=function(e){var r=Date.now(),i=Math.max(0,16-(r-n)),o=t.setTimeout(function(){e(r+i)},i);return n=r+i,o}),t.cancelAnimationFrame=t.cancelAnimationFrame||function(e){t.clearTimeout(e)}})();var I=t.darlingutil,U=t.darlingutil=t.darlingutil||{};U.version="0.0.0",U.noConflict=function(){var e=t.darlingutil;return t.darlingutil=I,e},function(){function e(t,e,n){var r=document.getElementById(t);if(null===r)throw Error("Can't find DOM element with id: \""+t+'"');var i=document.createElement("div");i.style.position="absolute",i.style.top="0px",r.appendChild(i);var o=document.createElement("canvas");return o.width=e||r.clientWidth,o.height=n||r.clientHeight,i.appendChild(o),o}function n(t){t.parentNode&&(t.parentNode.parentNode&&t.parentNode.parentNode.removeChild(t.parentNode),t.parentNode.removeChild(t))}function r(){var t=-1;if("Microsoft Internet Explorer"==navigator.appName){var e=navigator.userAgent,n=RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");null!=n.exec(e)&&(t=parseFloat(RegExp.$1))}return t}function i(){var e=0;if(t.opera){var n=t.opera.version();e=parseFloat(n)}return e}function o(t){var e={};if(e.x=0,e.y=0,null!==t)if(t.getBoundingClientRect){var n=document.documentElement,r=t.getBoundingClientRect(),i=n.scrollLeft,o=n.scrollTop;e.x=r.left+i,e.y=r.top+o}else{e.x=t.offsetLeft,e.y=t.offsetTop;for(var a=t.parentNode,$=null;null!==offsetParent;){e.x+=offsetParent.offsetLeft,e.y+=offsetParent.offsetTop;var f=offsetParent.tagName.toLowerCase();if((u&&"table"!=f||(c||p)&&"td"==f)&&($=kGetBorderWidth(offsetParent),e.x+=$.left,e.y+=$.top),offsetParent!=document.body&&offsetParent!=document.documentElement&&(e.x-=offsetParent.scrollLeft,e.y-=offsetParent.scrollTop),!s&&!v||l)for(;offsetParent!=a&&null!==a;)e.x-=a.scrollLeft,e.y-=a.scrollTop,(h||d)&&($=kGetBorderWidth(a),e.x+=$.left,e.y+=$.top),a=a.parentNode;a=offsetParent.parentNode,offsetParent=offsetParent.offsetParent}}return e}U.getCanvas=function(t){var e=document.getElementById(t);if(null===e)throw Error("Can't find DOM element with id: \""+t+'"');return U.isDefined(e.getContext)?e:null},U.placeCanvasInStack=e,U.removeCanvasFromStack=n;var a=navigator.userAgent,s=null!=navigator.appVersion.match(/MSIE/),$=r(),l=s&&$>=8,u=s&&!l,f=null!=a.match(/firefox/i),h=f&&(null!=a.match(/firefox\/2./i)||null!=a.match(/firefox\/1./i)),c=f&&!h,d=null!=navigator.appVersion.match(/WebKit/),p=null!=navigator.appVersion.match(/Chrome/),m=null!=t.opera,y=i(),v=m&&10>y,g=U;g.getElementAbsolutePlacement=function(t){var e=o(t);return e.width=t.offsetWidth,e.height=t.offsetHeight,e},g.getElementAbsolutePos=o}();var D=Object.prototype.toString;U.isDefined=n,U.isUndefined=r,U.isObject=i,U.isArray=o,U.isString=a,U.isWindow=s,U.isDate=$,U.isFunction=l;var L=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,q=/,/,B=/^\s*(_?)(\S+?)\1\s*$/,W=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,K=[],Y=K.slice,Q={on:function(t,e,n){if(!G(this,"on",t,[e,n])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);return r.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,n){if(!G(this,"once",t,[e,n])||!e)return this;var r=this,i=_.once(function(){r.off(t,i),e.apply(this,arguments)});return i._callback=e,this.on(t,i,n)},off:function(t,e,n){var r,i,o,a,s,$,l,u;if(!this._events||!G(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(a=t?[t]:_.keys(this._events),s=0,$=a.length;$>s;s++)if(t=a[s],o=this._events[t]){if(this._events[t]=r=[],e||n)for(l=0,u=o.length;u>l;l++)i=o[l],(e&&e!==i.callback&&e!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Y.call(arguments,1);if(!G(this,"trigger",t,e))return this;var n=this._events[t],r=this._events.all;return n&&z(n,e),r&&z(r,arguments),this},stopListening:function(t,e,n){var r=this._listeners;if(!r)return this;var i=!e&&!n;"object"==typeof e&&(n=this),t&&((r={})[t._listenerId]=t);for(var o in r)r[o].off(e,n,this),i&&delete this._listeners[o];return this}},V=/\s+/,G=function(t,e,n,r){if(!n)return!0;if("object"==typeof n){for(var i in n)t[e].apply(t,[i,n[i]].concat(r));return!1}if(V.test(n)){for(var o=n.split(V),a=0,s=o.length;s>a;a++)t[e].apply(t,[o[a]].concat(r));return!1}return!0},z=function(t,e){var n,r=-1,i=t.length,o=e[0],a=e[1],s=e[2];switch(e.length){case 0:for(;i>++r;)(n=t[r]).callback.call(n.ctx);return;case 1:for(;i>++r;)(n=t[r]).callback.call(n.ctx,o);return;case 2:for(;i>++r;)(n=t[r]).callback.call(n.ctx,o,a);return;case 3:for(;i>++r;)(n=t[r]).callback.call(n.ctx,o,a,s);return;default:for(;i>++r;)(n=t[r]).callback.apply(n.ctx,e)}};U.wipe=function(t){for(var e in t)t.hasOwnProperty(e)&&delete t[e]},U.clamp=function(t,e,n){return e>t?e:t>n?n:t},U.isConvexPolygonClockwise=function(t){if(!t)return e;if(3>t.length)return e;for(var n=0,r=t[n],i=null;++n<t.length&&(i=t[n],r.x===i.x&&r.y===i.y);)i=null;if(null===i)return e;for(var o=Math.atan2(i.y-r.y,i.x-r.x);++n<t.length;){var a=t[n];if(r.x!==a.x&&i.x!==a.x||r.y!==a.y&&i.y!==a.y){var s=Math.atan2(a.y-r.y,a.x-r.x),$=o-s;if($>Math.PI?$-=2*Math.PI:-Math.PI>$&&($+=2*Math.PI),0>$)return!1;if($>0)return!0}}};var J=t.darlingjs,X=t.darlingjs||(t.darlingjs={});X.version="0.0.0";var Z={},te={};X.noConflict=function(){var e=t.darlingjs;return t.darlingjs=J,e},X.m=X.module=function(t,e){if(n(te[t]))throw Error('Module "'+t+'" has already been defined.');var r=new ae;return r.$name=t,r.requires=e,te[t]=r,r},X.w=X.world=function(t,e){if(n(Z[t]))throw Error('World "'+t+'" has already been defined.');var i=new $e;if(i.$name=t,Z[t]=i,o(e))for(var a=0,s=e.length;s>a;a++){var $=e[a],l=te[$];if(r(l))throw Error("Can't find module: \""+$+'"');i.$$injectedModules[$]=l;var u=l.$$components;for(var f in u)if(u.hasOwnProperty(f)){var h=l.$$components[f];if(r(h))throw Error('Module: "'+$+'" has null component with name "'+f+'".');i.$$injectedComponents[h.$name]=h}var c=l.$$systems;for(var d in c)if(c.hasOwnProperty(d)){var p=c[d];if(r(p))throw Error('Module: "'+$+'" has null system with name "'+d+'".');i.$$injectedSystems[p.$name]=p}}return i},X.removeModule=function(t){delete te[t]},X.removeAllModules=function(){te={}},X.removeWorld=function(t){var e;if(a(t))e=t;else for(var n in Z)if(Z[n]===t){e=n;break}var r=Z[e];r.$removeAllSystems(),r.$stop(),delete Z[e]},X.removeAllWorlds=function(){Z={}};var ee=function(){};v(ee.prototype,Q),ee.prototype.$name="",ee.prototype.$$world=null,ee.prototype.$add=function(t,e){var n,i;if(a(t))n=this.$$world.$component(t,e),i=t;else{if(!b(t))throw r(t)?Error("Can't add component with null name."):Error("Can't add "+t+" to entity");n=t,i=n.$name}if(r(n))throw Error("Can't add null component.");return this[i]&&this.$remove(i),this[i]=n,this.trigger("add",this,n),n},ee.prototype.$remove=function(t){var n,r;if(b(t))r=t.$name,n=t;else{if(!a(t))throw Error("Can't remove from component "+t);r=t,n=this[t]}return this[r]?(this.trigger("remove",this,n),this[r]=null,n):e},ee.prototype.$has=function(t){return a(t)?!!this[t]:!!this[t.$name]},ee.prototype.$applyModifier=function(t){if(U.isFunction(t))t=t.call(this),U.isDefined(t)&&this.$applyModifier(t);else if(U.isString(t))this.$add(t);else if(U.isArray(t))for(var e=0,n=t.length;n>e;e++){var r=t[e];U.isFunction(r)&&(r=r.call(this)),this.$add(r)}else{if(!U.isObject(t))throw Error("Unknown modifier");for(var i in t){var o=t[i];U.isFunction(o)&&(o=o.call(this)),this.$add(i,o)}}},ee.prototype.$revertModifier=function(t){if(!U.isFunction(t))if(U.isString(t))this.$remove(t);else if(U.isArray(t))for(var e=0,n=t.length;n>e;e++){var r=t[e];U.isFunction(r)&&(r=r.call(this)),this.$remove(r)}else{if(!U.isObject(t))throw Error("Unknown modifier");for(var i in t)this.$remove(i)}},H.prototype.$marker=function(){return null===this.$$marker&&(this.$$marker="$$family_"+this.componentsString,this.nodes.PROPERTY_LINK_TO_NODE="$$listNode_of_"+this.$$marker),this.$$marker},H.prototype.newEntity=function(t){this.addIfMatch(t)},H.prototype.addIfMatch=function(t){if(!this.isInList(t)){for(var e=0,n=this.components.length;n>e;e++){var r=this.components[e];if(!t.$has(r))return}t.$$familyMarker||(t.$$familyMarker={}),t.$$familyMarker[this.$marker()]=!0,this.nodes.add(t)}},H.prototype.removeIfMatch=function(t,e){n(e)&&!this.componentsHash[e.$name]||!this.isInList(t)||(t.$$familyMarker[this.$$marker]=!1,this.nodes.remove(t))},H.prototype.isInList=function(t){return t.$$familyMarker&&t.$$familyMarker[this.$$marker]};var ne=function(t){this.$head=this.$tail=null,this._length=0,this.PROPERTY_LINK_TO_NODE=t?"$$listNode_"+t:"$$listNode_"+Math.random()};U.List=ne,v(ne.prototype,Q),ne.prototype.add=function(t){var e=oe.get();return e.init(t,this.PROPERTY_LINK_TO_NODE),this.$head?(this.$tail.$next=e,e.$prev=this.$tail,this.$tail=e):this.$head=this.$tail=e,t?this.trigger("add",t):this.trigger("add",e),this._length++,e},ne.prototype.addHead=function(t){var e=oe.get();return e.init(t,this.PROPERTY_LINK_TO_NODE),this.$head?(this.$head.$prev=e,e.$next=this.$head,this.$head=e):this.$head=this.$tail=e,t?this.trigger("add",t):this.trigger("add",e),this._length++,e},ne.prototype.remove=function(t){var e;if(t instanceof re)e=t;else{if(!t.$$linkNode||!t.$$linkNode[this.PROPERTY_LINK_TO_NODE])return!1;if(e=t.$$linkNode[this.PROPERTY_LINK_TO_NODE],null===e)return!1}return this.$tail===e&&(this.$tail=e.$prev),this.$head===e&&(this.$head=e.$next),null!==e.$prev&&(e.$prev.$next=e.$next),null!==e.$next&&(e.$next.$prev=e.$prev),e.dispose(t,this.PROPERTY_LINK_TO_NODE),this.trigger("remove",t),this._length--,!0},ne.prototype.length=function(){return this._length},ne.prototype.forEach=function(t,e,n){if(l(t)){var r,i=this.$head;if(e)for(;i;)r=i.$next,t.call(e,i.instance,n),i=r;else for(;i;)r=i.$next,t(i.instance,n),i=r}};var re=function(t,e){t&&this.init(t,e)};re.prototype.instance=null,re.prototype.$next=null,re.prototype.$prev=null,re.prototype.init=function(t,e){if(this.$prev=this.$next=null,t){if(this.instance=t,t.$$linkNode&&t.$$linkNode[e])throw Error("Can't store \""+t+'" because it contains '+e+" property."+t.$$linkNode[e]);t.$$linkNode||(t.$$linkNode={}),t.$$linkNode[e]=this}},re.prototype.dispose=function(t,e){this.$prev=this.$next=null,this.instance=null,t.$$linkNode&&(t.$$linkNode[e]=null),this.onDispose()};var ie=function(t){function e(){var e=new t;return e.onDispose=C,e.pool=r,e}var n=[],r=this;this.get=function(){if(0===n.length){var t=e();return t}return n.pop()},this.dispose=function(t){n.push(t)},this.warmup=function(t){for(var n=0;t>n;n++)e().onDispose();return this}};U.PoolOfObjects=ie;var oe=new ie(re).warmup(1024),ae=function(){this.$$components={},this.$$systems={}};ae.prototype.$name="",ae.prototype.$has=function(t){return n(this.$$components[t])||n(this.$$systems[t])},ae.prototype.$c=ae.prototype.$component=function(t,e){return e=e||{},e.$name=e.$name||t,this.$$components[t]=e,this},ae.prototype.$s=ae.prototype.$system=function(t,e){if(r(t))throw Error("System name must to be defined.");if(e=e||{},e.$name=t,n(this.$$systems[t]))throw Error('Module "'+this.$name+'" already has system with name "'+t+'".');return this.$$systems[t]=e,this};var se=function(){this.$$init()};v(se.prototype,Q),se.prototype.$name="",se.prototype.$$updateHandler=null,se.prototype.$$beforeUpdateHandler=null,se.prototype.$$afterUpdateHandler=null,se.prototype.$$addedHandler=null,se.prototype.$$removedHandler=null,se.prototype.$$addEntityHandler=null,se.prototype.$$removeEntityHandler=null,se.prototype.$$init=function(){this.$$setNodes(new ne)},se.prototype.$$setNodes=function(t){this.$nodes&&(this.$nodes.off("add"),this.$nodes.off("remove")),this.$nodes=t;var e=this;this.$nodes&&(this.$nodes.on("add",function(t){e.$$addEntityHandler(t)}),this.$nodes.on("remove",function(t){e.$$removeEntityHandler(t)}))},se.prototype.$$updateEveryNode=function(t,e){return function(n){this.$nodes.forEach(t,e,n)}};var $e=function(){this.$$injectedComponents={},this.$$injectedModules={},this.$$injectedSystems={},this.$$systems=[],this.$$beforeUpdateHandledSystems=[],this.$$afterUpdateHandledSystem=[],this.$$updateHandledSystem=[],this.$$families={},this.$$interval=1,this.$$updating=!1,this.$playing=!1,this.$entities=new ne("World"),this.$name=""};$e.prototype.$has=function(t){return n(this.$$injectedComponents[t])||n(this.$$injectedModules[t])||n(this.$$injectedSystems[t])},$e.prototype.$isUse=function(t){return t instanceof se?this.$$systems.indexOf(t)>=0:null!==this.$$getSystemByName(t)},$e.prototype.$add=function(t,e){var n;return t instanceof ee?n=this.$$addEntity(t):t instanceof se?this.$$addSystem(t):n=this.$system(t,e),n},$e.prototype.$$addEntity=function(t){return this.$entities.add(t),t.$$world=this,t.on("add",this.$$onComponentAdd,this),t.on("remove",this.$$onComponentRemove,this),this.$$matchNewEntityToFamilies(t),t},$e.prototype.$$removeEntity=function(t){return t.$$world=null,this.$entities.remove(t),this.$$matchRemoveEntityToFamilies(t),t.off("add",this.$$onComponentAdd),t.off("remove",this.$$onComponentRemove),t},$e.prototype.$$getDependencyByAnnotation=function(t,e){e=e||[];for(var n=0,r=t.length;r>n;n++){var i=t[n];e[n]=this.$$getDependencyByName(i)}return e},$e.prototype.$$getDependencyByName=function(t){switch(t){case"$world":return this}return this.$$getSystemByName(t)},$e.prototype.$$getSystemByName=function(t){for(var e=0,n=this.$$systems.length;n>e;e++)if(this.$$systems[e].$name===t)return this.$$systems[e];return null},$e.prototype.$remove=function(t){if(t instanceof ee)this.$$removeEntity(t);else{if(!(t instanceof se))throw Error("can't remove \""+t+'" from world "'+this.$name+'"');this.$$removeSystem(t)}},$e.prototype.$$addSystem=function(t){return this.$$systems.push(t),t.$$addedHandler(),n(t.$require)&&t.$$setNodes(this.$queryByComponents(t.$require)),t},$e.prototype.$$removeSystem=function(t){var e=this.$$systems.indexOf(t);return this.$$systems.splice(e,1),t.$nodes.forEach(t.$$removeEntityHandler,t),t.$$init(),t.$$removedHandler(),e=this.$$beforeUpdateHandledSystems.indexOf(t),e>=0&&this.$$beforeUpdateHandledSystems.splice(e,1),e=this.$$afterUpdateHandledSystem.indexOf(t),e>=0&&this.$$afterUpdateHandledSystem.splice(e,1),e=this.$$updateHandledSystem.indexOf(t),e>=0&&this.$$updateHandledSystem.splice(e,1),t},$e.prototype.$removeAllSystems=function(){var t,e=this.$$systems.length;for(t=0;e>t;t++){var n=this.$$systems[t];n.$nodes.forEach(n.$$removeEntityHandler,n),n.$$init()}for(t=0;e>t;t++)this.$$systems[t].$$removedHandler();this.$$systems.length=0,this.$$beforeUpdateHandledSystems.length=0,this.$$afterUpdateHandledSystem.length=0,this.$$updateHandledSystem.length=0},$e.prototype.$removeAllEntities=function(){for(var t=this.$entities.$head;t;){var e=t.instance,n=t.$next;this.$$removeEntity(e),t=n}},$e.prototype.$getByName=function(t){for(var e=this.$entities.$head;e;){var n=e.instance;if(n.$name===t)return n;e=e.$next}return null},$e.prototype.$numEntities=function(){return this.$entities.length()},$e.prototype.$e=$e.prototype.$entity=function(){var t="",e=0;a(arguments[0])&&(t=arguments[0],e=1);var s=new ee;if(s.$name=t,s.$$world=this,o(arguments[e])){var $=arguments[e];e++;for(var l=0,u=$.length;u>l;l++)if(a($[l])){var f,h=$[l],c=this.$$injectedComponents[h];if(r(c))throw Error("World "+this.$name+" doesn't has component "+h+". Only "+this.$$injectedComponents);i($[l+1])?(l++,f=$[l]):f=null,s.$add(h,f)}}else if(i(arguments[e])){var d=arguments[e];e++,O(d,s),n(d.$name)&&(s.$name=d.$name)}return arguments[e]||this.$$addEntity(s),s},$e.prototype.$c=$e.prototype.$component=function(t,e){var i,o;if(!a(t))throw Error("1st argument must be [String]");if(i=this.$$injectedComponents[t],r(i)){if(!n(e)||null===e)throw Error("Can't find component \""+t+'" definition. You need to add appropriate module to world.');this.$$injectedComponents[t]=e,o=e}else o=u(i),n(e)&&null!==e&&y(o,e);return o.$name=t,o},$e.prototype.$$annotatedFunctionFactory=function(t,e,i){var a=t[e];if(r(a))return null;if(o(a)){i=i||m;var s=a[a.length-1];t[e]=s;var $=c(a),l=this.$$getDependencyByAnnotation($),u=i($);return n(u)?F(s,t,l,u,e):g(s,t,l,e)}return a},$e.prototype.$s=$e.prototype.$system=function(t,e){var i=this.$$injectedSystems[t];if(r(i)&&r(e))throw Error('Instance of system "'+t+'" doesn\'t injected in the world "'+this.$name+'".');var a=new se;if(n(i)?u(i,a,!1):a.$name=a.$name||t,n(e)&&u(e,a,!1),a.$$beforeUpdateHandler=this.$$annotatedFunctionFactory(a,"$beforeUpdate",k),a.$$beforeUpdateHandler&&this.$$beforeUpdateHandledSystems.push(a),a.$$afterUpdateHandler=this.$$annotatedFunctionFactory(a,"$afterUpdate",k),a.$$afterUpdateHandler&&this.$$afterUpdateHandledSystem.push(a),n(a.$update)){if(o(a.$update)){var s=a.$update,$=s[s.length-1],l=c(s);a.$$update=$;var f=this.$$getDependencyByAnnotation(l),h=P(l,"$entity"),d=P(l,"$entities"),p=P(l,"$time"),y=P(l,"$world"),v=this,E=g($,a,f,"$$update"),w=l.indexOf("$entity")>=0;a.$$updateHandler=w?a.$$updateEveryNode(function(t,e){p(f,e),h(f,t),d(f,a.$nodes),y(f,v),E()}):function(t){p(f,t),d(f,a.$nodes),y(f,v),E()}}else a.$$updateHandler=a.$update;this.$$updateHandledSystem.push(a)}return a.$$addedHandler=n(a.$added)?this.$$annotatedFunctionFactory(a,"$added",m):m,a.$$removedHandler=n(a.$removed)?this.$$annotatedFunctionFactory(a,"$removed",m):m,a.$$addEntityHandler=n(a.$addEntity)?this.$$annotatedFunctionFactory(a,"$addEntity",j):m,a.$$removeEntityHandler=n(a.$removeEntity)?this.$$annotatedFunctionFactory(a,"$removeEntity",j):m,this.$$addSystem(a),a},$e.prototype.$$matchNewEntityToFamilies=function(t){if(A(t,"matchNewEntityToFamilies",this,this.$$matchNewEntityToFamilies,arguments)){for(var e in this.$$families)this.$$matchNewEntityToFamily(e,t);M(t,"matchNewEntityToFamilies")}},$e.prototype.$$matchNewEntityToFamily=function(t,e){var n=this.$$families[t];n.newEntity(e)},$e.prototype.$$matchRemoveEntityToFamilies=function(t){if(A(t,"matchRemoveEntityToFamilies",this,this.$$matchRemoveEntityToFamilies,arguments)){for(var e in this.$$families)this.$$matchRemoveEntityToFamily(e,t);M(t,"matchRemoveEntityToFamilies")}},$e.prototype.$$matchRemoveEntityToFamily=function(t,e){var n=this.$$families[t];n.removeIfMatch(e)},$e.prototype.$$onComponentAdd=function(t){if(A(t,"onComponentAdd",this,this.$$onComponentAdd,arguments)){for(var e in this.$$families)this.$$mapAddedComponentToFamily(e,t);M(t,"onComponentAdd")}},$e.prototype.$$mapAddedComponentToFamily=function(t,e){var n=this.$$families[t];n.addIfMatch(e)},$e.prototype.$$onComponentRemove=function(t,e){for(var n in this.$$families)this.$$mapRemovedComponentToFamily(n,t,e)},$e.prototype.$$mapRemovedComponentToFamily=function(t,e,n){var r=this.$$families[t];r.removeIfMatch(e,n)},$e.prototype.$queryByComponents=function(t){var e,n,r={};if(o(t))n=t.join(","),e=t;else{if(!a(t))throw Error("Can't query entities by "+t);n=t,e=t.split(",")}if(this.$$families[n])return this.$$families[n].nodes;for(var i=0,s=e.length;s>i;i++)r[e[i]]=!0;var $=new H;return $.components=e,$.componentsHash=r,$.componentsString=n,this.$$families[n]=$,this.$entities.forEach(function(t){$.newEntity(t)}),$.nodes},$e.prototype.$update=function(t){this.$$updating=!0,t=t||this.$$interval;var e,n,r;for(e=0,n=this.$$beforeUpdateHandledSystems.length;n>e;e++)r=this.$$beforeUpdateHandledSystems[e],r.$$beforeUpdateHandler(t,r.$nodes);for(e=0,n=this.$$updateHandledSystem.length;n>e;e++)r=this.$$updateHandledSystem[e],r.$$updateHandler(t);for(e=0,n=this.$$afterUpdateHandledSystem.length;n>e;e++)r=this.$$afterUpdateHandledSystem[e],r.$$afterUpdateHandler(t,r.$nodes);this.$$updating=!1},$e.prototype.$start=function(){if(!this.$playing){this.$playing=!0;var e=this,n=0;(function r(i){var o=0;n&&(o=i-n),e.$update(o),n=i,e.$playing&&(e.$requestAnimationFrameId=t.requestAnimationFrame(r))})(0)}},$e.prototype.$stop=function(){this.$playing&&(this.$playing=!1,t.cancelAnimationFrame(this.$requestAnimationFrameId))}})(window);